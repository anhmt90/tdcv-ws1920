function J = Jacobian_function(model3D, nextImage2D, camera_params, t, w)
% Compute Jacobian of the reprojection error with respect to the pose
% Arguments:
%   model3D: nx3 matrix of points from 3D model to be projected to the current frame (i+1)
%   nextImage2d: nx3 matrix of SIFT matches for the subsequent frame (image i+1)
%   camera_params: camera parameters containing intrinsic matrix
%   t: translation vector of the camera pose
%   w: orientation vector given in Exponential Maps
% Output:
%   J: Jacobian matrix

J = [];
tx = t(1); ty = t(2); tz = t(3);
wx = w(1); wy = w(2); wz = w(3);
f = camera_params.FocalLength(1);
u0 = camera_params.PrincipalPoint(1);
v0 = camera_params.PrincipalPoint(2);

for i = 1:size(model3D)
    X = model3D(i, 1); Y = model3D(i, 2); Z = model3D(i, 3);
    x = nextImage2D(i, 1); y = nextImage2D(i, 2);

    t2 = wx.^2;
    t3 = wy.^2;
    t4 = wz.^2;
    t5 = t2+t3+t4;
    t6 = sqrt(t5);
    t7 = sin(t6);
    t8 = 1.0./sqrt(t5);
    t9 = cos(t6);
    t10 = t9-1.0;
    t11 = 1.0./t5;
    t12 = t7.*t8.*wz;
    t13 = t10.*t11.*wx.*wy;
    t14 = t12+t13;
    t15 = t7.*t8.*wy;
    t16 = t7.*t8.*wx;
    t26 = t10.*t11.*wy.*wz;
    t17 = t16-t26;
    t18 = t10.*t11.*wx.*wz;
    t19 = t15+t18;
    t20 = t3+t4;
    t21 = t10.*t11.*t20;
    t22 = t21+1.0;
    t23 = t2+t3;
    t24 = t10.*t11.*t23;
    t25 = t24+1.0;
    t27 = t17.*ty;
    t28 = t25.*tz;
    t29 = t15-t18;
    t30 = 1.0./t5.^(3.0./2.0);
    t31 = 1.0./t5.^2;
    t32 = t7.*t30.*wx.*wz;
    t33 = t2.*t7.*t30.*wy;
    t34 = t2.*t10.*t31.*wy.*2.0;
    t108 = t10.*t11.*wy;
    t109 = t9.*t11.*wx.*wz;
    t35 = t32+t33+t34-t108-t109;
    t36 = t9.*t11.*wx.*wy;
    t37 = t2.*t7.*t30.*wz;
    t38 = t2.*t10.*t31.*wz.*2.0;
    t39 = t7.*t8;
    t40 = t2.*t9.*t11;
    t41 = t10.*t31.*wx.*wy.*wz.*2.0;
    t42 = t7.*t30.*wx.*wy.*wz;
    t71 = t2.*t7.*t30;
    t43 = t39+t40+t41+t42-t71;
    t44 = t10.*t20.*t31.*wx.*2.0;
    t45 = t7.*t20.*t30.*wx;
    t46 = t44+t45;
    t47 = t7.*t30.*wx.*wy;
    t52 = t10.*t11.*wz;
    t48 = -t36+t37+t38+t47-t52;
    t49 = t10.*t23.*t31.*wx.*2.0;
    t50 = t7.*t23.*t30.*wx;
    t69 = t10.*t11.*wx.*2.0;
    t51 = t49+t50-t69;
    t53 = X.*t19;
    t63 = t19.*tx;
    t73 = Y.*t17;
    t74 = Z.*t25;
    t54 = t27+t28+t53-t63-t73-t74;
    t55 = 1.0./t54;
    t56 = f.*t14;
    t79 = t17.*u0;
    t57 = t56-t79;
    t58 = Y.*t57;
    t59 = t29.*tz;
    t60 = t22.*tx;
    t80 = t14.*ty;
    t61 = t59+t60-t80;
    t62 = f.*t61;
    t64 = f.*t22;
    t81 = t19.*u0;
    t65 = t64-t81;
    t66 = f.*t29;
    t67 = t25.*u0;
    t68 = t66+t67;
    t70 = t48.*tx;
    t72 = t43.*ty;
    t75 = t36+t37+t38-t47-t52;
    t76 = t27+t28-t63;
    t77 = t76.*u0;
    t82 = X.*t65;
    t83 = Z.*t68;
    t78 = t58+t62+t77-t82-t83;
    t107 = t55.*t78;
    t84 = -t107+x;
    t85 = sign(t84);
    t86 = t3.*t7.*t30;
    t87 = t10.*t20.*t31.*wy.*2.0;
    t88 = t7.*t20.*t30.*wy;
    t92 = t10.*t11.*wy.*2.0;
    t89 = t87+t88-t92;
    t90 = t3.*t9.*t11;
    t91 = t39+t41+t42-t86+t90;
    t93 = t10.*t23.*t31.*wy.*2.0;
    t94 = t7.*t23.*t30.*wy;
    t95 = t7.*t30.*wy.*wz;
    t96 = t3.*t7.*t30.*wx;
    t97 = t3.*t10.*t31.*wx.*2.0;
    t110 = t10.*t11.*wx;
    t111 = t9.*t11.*wy.*wz;
    t98 = t95+t96+t97-t110-t111;
    t99 = t3.*t7.*t30.*wz;
    t100 = t3.*t10.*t31.*wz.*2.0;
    t101 = t36-t47-t52+t99+t100;
    t102 = -t39+t41+t42+t86-t90;
    t103 = -t92+t93+t94;
    t104 = t101.*ty;
    t105 = t102.*tx;
    t106 = 1.0./t54.^2;
    t112 = t4.*t7.*t30.*wy;
    t113 = t4.*t10.*t31.*wy.*2.0;
    t114 = -t32-t108+t109+t112+t113;
    t115 = t4.*t7.*t30.*wx;
    t116 = t4.*t10.*t31.*wx.*2.0;
    t117 = t4.*t7.*t30;
    t172 = t4.*t9.*t11;
    t118 = -t39+t41+t42+t117-t172;
    t119 = t10.*t23.*t31.*wz.*2.0;
    t120 = t7.*t23.*t30.*wz;
    t121 = t119+t120;
    t122 = -t95-t110+t111+t115+t116;
    t123 = t10.*t20.*t31.*wz.*2.0;
    t124 = t7.*t20.*t30.*wz;
    t174 = t10.*t11.*wz.*2.0;
    t125 = t123+t124-t174;
    t126 = t95-t110-t111+t115+t116;
    t127 = t126.*tx;
    t128 = t114.*ty;
    t129 = t12-t13;
    t130 = t2+t4;
    t131 = t10.*t11.*t130;
    t132 = t131+1.0;
    t133 = t16+t26;
    t134 = t10.*t31.*t130.*wx.*2.0;
    t135 = t7.*t30.*t130.*wx;
    t136 = -t69+t134+t135;
    t137 = -t39-t40+t41+t42+t71;
    t155 = t51.*tz;
    t138 = t70+t72-t155;
    t139 = -t32+t33+t34-t108+t109;
    t140 = f.*t129;
    t156 = t19.*v0;
    t141 = t140-t156;
    t142 = t129.*tx;
    t143 = t132.*ty;
    t158 = t133.*tz;
    t144 = t142+t143-t158;
    t145 = f.*t144;
    t146 = t76.*v0;
    t147 = t17.*v0;
    t148 = f.*t132;
    t149 = t147+t148;
    t150 = f.*t133;
    t160 = t25.*v0;
    t151 = t150-t160;
    t152 = Z.*t151;
    t157 = X.*t141;
    t159 = Y.*t149;
    t153 = t145+t146+t152-t157-t159;
    t154 = Z.*t51;
    t171 = t55.*t153;
    t161 = -t171+y;
    t162 = sign(t161);
    t163 = -t95+t96+t97-t110+t111;
    t170 = t103.*tz;
    t164 = t104+t105-t170;
    t165 = t10.*t31.*t130.*wy.*2.0;
    t166 = t7.*t30.*t130.*wy;
    t167 = t165+t166;
    t168 = -t36+t47-t52+t99+t100;
    t169 = Z.*t103;
    t181 = t121.*tz;
    t173 = t127+t128-t181;
    t175 = t39+t41+t42-t117+t172;
    t176 = t32-t108-t109+t112+t113;
    t177 = t10.*t31.*t130.*wz.*2.0;
    t178 = t7.*t30.*t130.*wz;
    t179 = -t174+t177+t178;
    t180 = Z.*t121;
    
    J = [J; reshape([-t85.*(t55.*(t138.*u0+X.*(f.*t46-t48.*u0)-Y.*(f.*t35+t43.*u0)-Z.*(f.*t75-t51.*u0)+f.*(-t46.*tx+t35.*ty+t75.*tz))-t78.*t106.*(t70+t72+t154-X.*t48-Y.*t43-t51.*tz)),-t162.*(t55.*(t138.*v0-X.*(f.*t139+t48.*v0)+Y.*(f.*t136-t43.*v0)-Z.*(f.*t137-t51.*v0)+f.*(t139.*tx-t136.*ty+t137.*tz))-t106.*t153.*(t70+t72+t154-t155-X.*t48-Y.*t43)),-t85.*(t55.*(t164.*u0+X.*(f.*t89-t102.*u0)-Y.*(f.*t98+t101.*u0)-Z.*(f.*t91-t103.*u0)+f.*(-t89.*tx+t98.*ty+t91.*tz))-t78.*t106.*(t104+t105+t169-X.*t102-Y.*t101-t103.*tz)),-t162.*(t55.*(t164.*v0-X.*(f.*t163+t102.*v0)+Y.*(f.*t167-t101.*v0)-Z.*(f.*t168-t103.*v0)+f.*(t163.*tx-t167.*ty+t168.*tz))-t106.*t153.*(t104+t105+t169-t170-X.*t102-Y.*t101)),-t85.*(t55.*(t173.*u0+X.*(f.*t125-t126.*u0)-Y.*(f.*t118+t114.*u0)-Z.*(f.*t122-t121.*u0)+f.*(-t125.*tx+t118.*ty+t122.*tz))-t78.*t106.*(t127+t128+t180-X.*t126-Y.*t114-t121.*tz)),-t162.*(t55.*(t173.*v0-X.*(f.*t175+t126.*v0)+Y.*(f.*t179-t114.*v0)-Z.*(f.*t176-t121.*v0)+f.*(t175.*tx-t179.*ty+t176.*tz))-t106.*t153.*(t127+t128+t180-t181-X.*t126-Y.*t114)),-t85.*(t55.*t65+t19.*t78.*t106),-t162.*(t55.*t141+t19.*t106.*t153),t85.*(t55.*t57+t17.*t78.*t106),-t162.*(t55.*t149-t17.*t106.*t153),-t85.*(t55.*t68-t25.*t78.*t106),t162.*(t55.*t151+t25.*t106.*t153)],[2,6])];
end